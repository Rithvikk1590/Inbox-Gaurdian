<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Analysis - {{ email.filename }} - Inbox Guardian</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
  <!-- Navbar -->
  <header class="topbar" style="position: sticky; top: 0; z-index: 1050;">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark border-bottom">
      <div class="container">
        <!-- Brand -->
        <a class="navbar-brand d-flex align-items-center" href="/">
          <span class="bg-success text-dark fw-bold rounded-3 px-2 py-1 me-2">IG</span>
          <span class="fw-semibold">Inbox Guardian</span>
        </a>

        <!-- Hamburger -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#igNavbar"
          aria-controls="igNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Left-aligned nav items -->
        <div class="collapse navbar-collapse" id="igNavbar">
          <ul class="navbar-nav ms-3">
            <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="/guide">Guide</a></li>
            <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Analysis</a></li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Analysis Header -->
  <section class="hero text-center my-4">
    <h1>Email Analysis Results</h1>
    <p class="text-muted">Analyzing: <strong>{{ email.filename }}</strong></p>
    <p class="text-warning">Total Risk Points: {{ analysis.total_risk_points }}</p>
  </section>

  <!-- Email Content with Highlighting -->
  <section class="container my-4">
    <div class="card bg-dark border-success">
      <div class="card-header bg-success text-dark">
        <h5 class="mb-0">Email Content Analysis</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive mb-4">
          <table class="table table-dark table-borderless">
            <tbody>
              <tr>
                <td class="fw-bold text-success" style="width: 150px;">Subject:</td>
                <td class="text-light" id="email-subject">{{ email.subject }}</td>
              </tr>
              <tr>
                <td class="fw-bold text-success">To:</td>
                <td class="text-light" id="email-to">{{ email.receiver }}</td>
              </tr>
              <tr>
                <td class="fw-bold text-success">From:</td>
                <td class="text-light" id="email-from">{{ email.sender }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="mb-3">
          <h6 class="text-success">Email Body:</h6>
          <div class="email-body-container">
            <pre class="text-light mb-0 email-body-content" id="email-body">{{ email.body }}</pre>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Action Button -->
  <section class="container mb-5">
    <div class="text-center">
      <a href="/" class="btn btn-success btn-lg">
        Analyze Another Email
      </a>
    </div>
  </section>

  <!-- Custom Tooltip -->
  <div class="custom-tooltip" id="customTooltip" style="display: none;">
    <div class="tooltip-inner"></div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // Collect all elements we want to scan
    const targets = [
      document.getElementById('email-body'),
      document.getElementById('email-subject'),
      document.getElementById('email-to'),
      document.getElementById('email-from')
    ].filter(Boolean);

    const highlights = {{ analysis.body_highlights | tojson | safe if analysis.body_highlights else '[]' }};
    if (!Array.isArray(highlights) || highlights.length === 0) return;

    // Escape helpers
    const escRe = s => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const escAttr = s => String(s)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');

    targets.forEach(el => {
      let content = el.textContent;
      highlights.forEach(h => {
        if (!h || !h.text) return;
        const regex = new RegExp(escRe(h.text), 'gi');
        const hoverMsg = escAttr(h.hover_message || '');
        const replacement =
          `<span style="background-color: yellow; color: black; font-weight: bold; padding: 0 2px; border-radius: 2px;" ` +
          `onmouseover="showTooltip(event, '${hoverMsg}')" ` +
          `onmouseout="hideTooltip()">${escAttr(h.text)}</span>`;
        content = content.replace(regex, replacement);
      });
      el.innerHTML = content;
    });
  });

  function showTooltip(event, text) {
    const tooltip = document.getElementById('customTooltip');
    tooltip.querySelector('.tooltip-inner').textContent = text || '';
    tooltip.style.display = 'block';
    tooltip.style.position = 'absolute';
    tooltip.style.left = event.pageX + 10 + 'px';
    tooltip.style.top = event.pageY - 30 + 'px';
    tooltip.style.zIndex = '9999';
  }

  function hideTooltip() {
    document.getElementById('customTooltip').style.display = 'none';
  }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Analysis - {{ email.filename }} - Inbox Guardian</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    pre {
      line-height: 1.25;
      font-size: 1rem;
      margin: 0;
    }

    .ig-highlight {
      vertical-align: baseline;
    }
  </style>
</head>

<body>
  {% include 'includes/navbar.html' %}

  <!-- Header -->
  <section class="hero text-center py-3">
    <div class="d-flex justify-content-center align-items-center gap-3 mb-2">

      <div class="badge-box px-4 py-2 bg-white text-dark border rounded-2 shadow-sm">
        Analyzing: <strong>{{ email.filename }}</strong>
      </div>

      <div class="badge-box px-4 py-2 rounded-2 text-white fw-semibold shadow-sm" style="background-color: {% if analysis.total_risk_points > 50 %}#dc3545
      {% elif analysis.total_risk_points > 20 %}#ffc107; color:#000
      {% else %}#28a745
      {% endif %};">
        Total Risk: <strong>{{ analysis.total_risk_points }}</strong> points
      </div>

      <div class="badge-box px-4 py-2 rounded-2 text-white fw-bold shadow-sm" style="background-color:
      {% if analysis.verdict == 'Phishing' or analysis.verdict == 'Likely phishing' %}#dc3545
      {% elif analysis.verdict == 'Suspicious' %}#ffc107; color:#000
      {% else %}#28a745
      {% endif %};">
        Rule-Based Verdict: <strong>{{ analysis.verdict }}</strong>
      </div>

      <div class="badge-box px-4 py-2 rounded-2 text-white fw-bold shadow-sm" style="background-color: #007bff;">
        Machine Learning Verdict: <strong>{{ ml_output }}</strong>
      </div>

    </div>
  </section>

  <!-- Sender -->
  <section class="container my-3">
    <div class="card-header bg-dark text-white p-2">
      <h5 class="mb-0 text-white fw-semibold">Sender</h5>
    </div>
    <pre id="email-from" class="bg-body-tertiary text-dark p-2 m-0 rounded-0 border-0">{{ email.sender | trim }}</pre>
  </section>

  <!-- Subject -->
  <section class="container my-3">
    <div class="card-header bg-dark text-white p-2">
      <h5 class="mb-0 text-white fw-semibold">Subject</h5>
    </div>
    <pre id="email-subject"
      class="bg-body-tertiary text-dark p-2 m-0 rounded-0 border-0">{{ email.subject | trim }}</pre>
  </section>

  <!-- Body -->
  <section class="container my-3">
  <div class="card-header bg-dark text-white p-2 d-flex justify-content-between align-items-center">
    <h5 class="mb-0 text-white fw-semibold">Email</h5>
    <div id="placement-info-container" class="placement-badges"></div>
  </div>
  <pre id="email-body" class="bg-body-tertiary text-dark p-2 m-0 rounded-0 border-0">{{ email.body | trim }}</pre>
</section>

  <!-- Attachments -->
  <section class="container my-3">
    <div class="card-header bg-dark text-white p-2">
      <h5 class="mb-0 text-white fw-semibold">Attachment</h5>
    </div>
    <div id="email-attachments" class="bg-body-tertiary text-dark p-2 m-0 rounded-0 border-0">
      {% if analysis.attachment_warnings %}
      <ul style="list-style:none; padding-left:0; margin:0;">
        {% for warn in analysis.attachment_warnings %}
        <li style="
                  {% if warn.risk_level == 'high' %}
                      background-color:#f5c6cb;
                  {% elif warn.risk_level == 'medium' %}
                      background-color:#ffeeba;
                  {% else %}
                      background-color:#d4edda;
                  {% endif %}
                  color:#000; padding:6px; margin-bottom:4px; border-radius:4px;">
          <strong>{{ warn.filename }}</strong><br>
          <small>{{ warn.message }}</small>
        </li>
        {% endfor %}
      </ul>
      {% elif email.attachments %}
      <ul style="list-style:none; padding-left:0; margin:0;">
        {% for a in email.attachments %}
        <li style="background-color:#d4edda; color:#000; padding:6px; margin-bottom:4px; border-radius:4px;">
          {{ a }} (Safe)
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="m-0">No attachments</p>
      {% endif %}
    </div>
  </section>

  <!-- Tooltip -->
  <div id="customTooltip" class="position-fixed text-white p-2 rounded shadow-sm small text-center"
    style="max-width: 300px; display: none; z-index: 1070; pointer-events: none;" aria-hidden="true">
    <div id="tooltipText" style="white-space: pre-wrap;"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const targets = [
        document.getElementById('email-body'),
        document.getElementById('email-subject'),
        document.getElementById('email-from')
      ].filter(Boolean);

      const highlights = {{ analysis.body_highlights | tojson | safe if analysis.body_highlights else '[]'
    }};
    if (!Array.isArray(highlights) || highlights.length === 0) return;

    const escRe = s => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const escHtml = s => String(s)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');

    const mergedMap = new Map();
    for (const h of highlights) {
      if (!h || !h.text) continue;
      const key = `${h.section || 'any'}|${String(h.text).toLowerCase()}`;
      if (!mergedMap.has(key)) {
        mergedMap.set(key, { 
          text: h.text.trim(), 
          section: h.section || 'any', 
          risk_level: h.risk_level || 'medium', 
          messages: [] });
      }
      const msg = h.hover_message || h.message || h.reason || h.label || 'Flagged item';
      if (msg) mergedMap.get(key).messages.push(msg);
    }
    const merged = Array.from(mergedMap.values());

    targets.forEach(el => {
      let content = el.textContent;
      merged.forEach(h => {
        const regex = new RegExp(escRe(h.text), 'gi');
        const tooltip = escHtml(h.messages.filter(Boolean).join('&#10;â€¢ '));

        // assign colour by risk level
        let color = "#fff"; // default white
        if (h.risk_level === "high") color = "#ff4d4d";      // red
        else if (h.risk_level === "medium") color = "#ffcc00"; // amber
        else if (h.risk_level === "low") color = "#7CFC00";    // green
        else if (h.risk_level === "info") color = "#00bfff";   // blue

        const replacement =
          `<span class="ig-highlight" style="display:inline; vertical-align:baseline; background-color:${color}; color:black; font-weight:bold; padding:1px 2px; border-radius:3px; line-height:1;" data-tooltip="${tooltip}">${escHtml(h.text)}</span>`;

        content = content.replace(regex, replacement);
      });
      el.innerHTML = content;

      el.addEventListener('mouseover', e => {
        const t = e.target.closest('.ig-highlight');
        if (!t) return;
        showTooltip(e, t.getAttribute('data-tooltip') || '', t.style.backgroundColor);
      });
      el.addEventListener('mousemove', positionTooltip);
      el.addEventListener('mouseout', hideTooltip);
    });

    const container = document.getElementById('placement-info-container');
    if (container) {
      container.innerHTML = ''; // or use remove() on children for better perf if needed

      // Filter all placement highlights
      const placementHighlights = highlights.filter(h => h.placement_info);

      // Create a badge for each
      placementHighlights.forEach(highlight => {
        const badge = document.createElement('div');
        badge.className = 'placement-badge';
        badge.textContent = highlight.hover_message;
        container.appendChild(badge);
      });

      // Optional: hide container if no badges
      container.style.display = placementHighlights.length ? 'flex' : 'none';
    }
    });

    function showTooltip(event, text, bgColor) {
      const tooltip = document.getElementById('customTooltip');
      const tooltipText = document.getElementById('tooltipText');
      const decoded = (text || '').replace(/&#10;/g, '\n');
      tooltipText.textContent = decoded;
      tooltip.style.backgroundColor = bgColor || '#333';
      tooltip.style.display = 'block';
      positionTooltip(event);
    }

    function positionTooltip(event) {
      const tooltip = document.getElementById('customTooltip');
      tooltip.style.left = `${event.pageX - tooltip.offsetWidth / 2}px`;
      tooltip.style.top = `${event.pageY - tooltip.offsetHeight - 12}px`;
    }

    function hideTooltip() {
      document.getElementById('customTooltip').style.display = 'none';
    }
  </script>
</body>

</html>
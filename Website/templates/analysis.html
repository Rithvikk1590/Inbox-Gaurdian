<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Analysis - {{ email.filename }} - Inbox Guardian</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
  {% include 'includes/navbar.html' %}
  <!-- Analysis Header -->
<section class="hero text-center py-3">
  <div class="container">
    <h1 class="display-4 fw-bold mb-2">Email Analysis Results</h1>
    <div class="d-flex flex-column align-items-center gap-2 mb-4"></div>
      <div class="d-inline-block mb-2 px-4 py-2 bg-white text-dark border rounded-2 shadow-sm">
        Analyzing: <strong>{{ email.filename }}</strong>
      </div>
      <div class="d-inline-block ms-3 mb-2 px-4 py-2 rounded-2 text-white"
          style="background-color: {% if analysis.total_risk_points > 50 %}#dc3545{% elif analysis.total_risk_points > 20 %}#ffc107; color: #000{% else %}#28a745{% endif %};">
        Total Risk: <strong>{{ analysis.total_risk_points }}</strong> points
      </div>
    </div>
  </div>
</section>

<!-- Sender -->
<section class="container my-4">
    <div class="card-header bg-dark text-white d-flex align-items-center gap-2 p-3 border-0 rounded-top-2">
      <i class="bi bi-chat-left-text fs-4"></i>
      <h5 class="mb-0 text-white fw-semibold">Sender</h5>
    </div>
    <div class="card-body p-0 m-0 border-0">
      <pre id="email-from" class="bg-body-tertiary text-wrap text-dark p-4 m-0 rounded-0 border-0">
        {{ email.sender }}
      </pre>
    </div>
</section>

<!-- Subject -->
<section class="container my-4">
    <div class="card-header bg-dark text-white d-flex align-items-center gap-2 p-3 border-0 rounded-top-2">
      <i class="bi bi-chat-left-text fs-4"></i>
      <h5 class="mb-0 text-white fw-semibold">Subject</h5>
    </div>
    <div class="card-body p-0 m-0 border-0">
      <pre id="email-from" class="bg-body-tertiary text-wrap text-dark p-4 m-0 rounded-0 border-0">
        {{ email.subject }}
      </pre>
    </div>
</section>

<!-- Body -->
<section class="container my-4">
    <div class="card-header bg-dark text-white d-flex align-items-center gap-2 p-3 border-0 rounded-top-2">
      <i class="bi bi-chat-left-text fs-4"></i>
      <h5 class="mb-0 text-white fw-semibold">Email</h5>
    </div>
    <div class="card-body p-0 m-0 border-0">
      <pre id="email-body" class="bg-body-tertiary text-wrap text-dark p-4 m-0 rounded-0 border-0">
        {{ email.body }}
      </pre>
    </div>
</section>

<!-- Attachments -->
<section class="container my-4">
    <div class="card-header bg-dark text-white d-flex align-items-center gap-2 p-3 border-0 rounded-top-2">
      <i class="bi bi-chat-left-text fs-4"></i>
      <h5 class="mb-0 text-white fw-semibold">Attachment</h5>
    </div>
    <div class="card-body p-0 m-0 border-0">
      <pre id="email-from" class="bg-body-tertiary text-wrap text-dark p-4 m-0 rounded-0 border-0">
        {% if email.attachments %}
          {% for a in email.attachments %}
            {{ a }}
          {% endfor %}
        {% else %}
          <span class="text-dark">No attachments</span>
        {% endif %}
      </pre>
    </div>
</section>

<!-- Attachment Warnings -->
{% if analysis.attachment_warnings %}
<section class="container my-4">
  <div class="alert alert-warning border border-warning d-flex align-items-start shadow-sm">
    <i class="bi bi-exclamation-triangle-fill fs-3 me-3 mt-1"></i>
    <div>
      <h6 class="mb-1 text-danger">⚠️ Suspicious Attachments Detected</h6>
      <ul class="mb-0">
        {% for w in analysis.attachment_warnings %}
          <li>{{ w.message }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</section>
{% endif %}

<!-- Other Warnings / Insights -->
{% if analysis.other_warnings %}
<section class="container my-4">
  <div class="card border-warning bg-warning bg-opacity-10 shadow-sm">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0"><i class="bi bi-shield-exclamation me-2"></i>Potential Risks</h5>
    </div>
    <div class="card-body">
      <ul class="mb-0">
        {% for warning in analysis.other_warnings %}
          <li>{{ warning }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</section>
{% endif %}

<!-- Action Button -->
<section class="container my-5 text-center">
  <a href="/" class="btn btn-lg btn-outline-primary px-3 rounded-3">
    <i class="bi bi-upload me-2"></i>Analyze Another Email
  </a>
</section>

<!-- Custom Tooltip -->
<div id="customTooltip"
     class="position-fixed bg-danger text-white p-2 rounded shadow-sm small text-center"
     style="max-width: 300px; display: none; z-index: 1070; pointer-events: none;"
     aria-hidden="true">
  <div id="tooltipText"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Collect all elements we want to scan
    const targets = [
      document.getElementById('email-body'),
      document.getElementById('email-subject'),
      document.getElementById('email-to'),
      document.getElementById('email-from')
    ].filter(Boolean);

    const highlights = {{ analysis.body_highlights | tojson | safe if analysis.body_highlights else '[]' }};
    if (!Array.isArray(highlights) || highlights.length === 0) return;

    // Escape helpers
    const escRe = s => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const escAttr = s => String(s)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');

    targets.forEach(el => {
      let content = el.textContent;
      highlights.forEach(h => {
        if (!h || !h.text) return;
        const regex = new RegExp(escRe(h.text), 'gi');
        const hoverMsg = escAttr(h.hover_message || '');
        const replacement =
          `<span style="background-color: yellow; color: black; font-weight: bold; padding: 0 2px; border-radius: 2px;" ` +
          `onmouseover="showTooltip(event, '${hoverMsg}')" ` +
          `onmouseout="hideTooltip()">${escAttr(h.text)}</span>`;
        content = content.replace(regex, replacement);
      });
      el.innerHTML = content;
    });
  });

  function showTooltip(event, text) {
    const tooltip = document.getElementById('customTooltip');
    const tooltipText = document.getElementById('tooltipText');
    tooltipText.textContent = text || '';
    tooltip.style.display = 'block';
    // Get the element that triggered the event
    const target = event.target;
    // Get position of the highlighted word
    const rect = target.getBoundingClientRect();
    // Position tooltip just above the word
    tooltip.style.left = `${rect.left + window.scrollX + rect.width / 2 - tooltip.offsetWidth / 2}px`;
    tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 8}px`; // 8px gap
  }

  function hideTooltip() {
    document.getElementById('customTooltip').style.display = 'none';
  }
</script>

</body>
</html>
